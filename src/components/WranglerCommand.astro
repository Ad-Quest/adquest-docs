---
import { z } from "astro:schema";
import AnchorHeading from "./AnchorHeading.astro";
import { PackageManagers } from "starlight-package-managers";
import WranglerArg from "./WranglerArg.astro";
import Details from "./Details.astro";
import { marked } from "marked";
import { commands, getCommand } from "~/util/wrangler";
import { parse } from "node-html-parser";
import { Badge } from "@astrojs/starlight/components";

const props = z.object({
	command: z.string(),
	headingLevel: z.number().default(2),
	description: z.string().optional(),
});

let { command, headingLevel, description } = props.parse(Astro.props);

const definition = getCommand(command);

description ??= definition.metadata.description;
// will be appended after the main description, if present
const epilogue = definition.metadata.epilogue;

// CED-192 - some commands are experimental and need to be marked as such
const experimental = definition.metadata.status === "experimental";

// CED-191 some commands are present but marked as "hidden" and shouldn't be shown
if (definition.metadata.hidden) {
	throw new Error(
		`[WranglerCommand] "${command}" is marked as hidden. If you want to publish, fix upstream in workers-sdk repo.`
	);
}

if (!definition.args) {
	console.warn(`[WranglerCommand] "${command}" has no arguments`);
}

const { globalFlags } = commands;

const positionals = definition.positionalArgs
	?.map((p) => `[${p.toUpperCase()}]`)
	.join(" ");

const positionalSet = new Set(definition.positionalArgs);

// Extract ExtraFlagDetails from slot
const slotContent = await Astro.slots.render("default");
const extraFlagDetailsMap = new Map<
	string,
	{ content: string; mode: "append" | "replace" }
>();

if (slotContent) {
	const html = parse(slotContent);
	const extraFlagElements = html.querySelectorAll("div[data-extra-flag-key]");

	for (const element of extraFlagElements) {
		const key = element.getAttribute("data-extra-flag-key");
		const mode = element.getAttribute("data-extra-flag-mode") || "append";

		if (key) {
			extraFlagDetailsMap.set(key, {
				content: element.innerHTML.trim(),
				mode: mode as "append" | "replace",
			});
		}
	}
}
---

<AnchorHeading depth={headingLevel} title={`\`${command}\``} />

<!-- CED-192 - Label experimental commands with a badge-->
{
	experimental && (
		<>
			<br />
			<Badge text="Experimental" variant="caution" />
		</>
	)
}
<Fragment set:html={marked.parse(description)} />

{epilogue && <Fragment set:html={marked.parse(epilogue)} />}

<PackageManagers
	pkg="wrangler"
	type="exec"
	args={positionals ? command.concat(` ${positionals}`) : command}
/>

<!-- CED-181 - Not all commands have specific arguments as part of the payload -->
{
	definition.args && (
		<ul>
			{Object.entries(definition.args)
				.filter(([_, value]) => !value.hidden)
				.map(([key, value]) => {
					return (
						<WranglerArg
							key={key}
							definition={{ ...value, positional: positionalSet.has(key) }}
							extraDetails={extraFlagDetailsMap.get(key)}
						/>
					);
				})}
		</ul>
	)
}

<Details header="Global flags">
	<ul>
		{
			Object.entries(globalFlags).map(([key, value]) => {
				return <WranglerArg key={key} definition={value} />;
			})
		}
	</ul>
</Details>
