---
import { z } from "astro:schema";
import { experimental_getWranglerCommands } from "wrangler";
import AnchorHeading from "./AnchorHeading.astro";
import Type from "./Type.astro";
import { PackageManagers } from "starlight-package-managers";
import MetaInfo from "./MetaInfo.astro";

function getCommand(path: string) {
	const segments = path.trim().split(/\s+/);

	const { subtree } = experimental_getWranglerCommands();

	let node = subtree;
	for (const segment of segments) {
		const next = node.get(segment);

		if (!next) break;

		if (next.subtree.size === 0 && next.definition?.type === "command") {
			return next.definition;
		}

		node = next.subtree;
	}

	throw new Error(`[WranglerCommand] Command "${path}" not found`);
}

const props = z.object({
	command: z.string(),
});

let { command } = props.parse(Astro.props);

const definition = getCommand(command);

if (!definition.args) {
	throw new Error(`[WranglerCommand] "${command}" has no arguments`);
}

const positionals = definition.positionalArgs;

if (positionals && positionals.length > 0) {
	const display = positionals.map((p) => `[${p.toUpperCase()}]`).join(" ");

	command = command.concat(" ".concat(display));
}
---

<AnchorHeading depth={2} title={definition.command} />

<p>{definition.metadata?.description}</p>

<PackageManagers pkg="wrangler" type="exec" args={command} />

<AnchorHeading
	depth={3}
	title="Arguments"
	slug={`${definition.command.replaceAll(" ", "-")}-arguments`}
/>

<ul>
	{
		Object.entries(definition.args).map(([key, value]) => {
			const required = value.demandOption;
			const defaultValue = value.default;

			return (
				<li>
					<code>{key}</code> <Type text={value.type} />{" "}
					{required && <MetaInfo text="required" />}
					{defaultValue !== undefined && (
						<MetaInfo text={`default: ${defaultValue}`} />
					)}
					<p>{value.description}</p>
				</li>
			);
		})
	}
</ul>
