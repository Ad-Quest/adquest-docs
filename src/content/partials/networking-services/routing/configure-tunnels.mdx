---
params:
  - magicWord
  - ipRange?
  - productName
  - tunnelsAndEncapsulationPagePath
  - ciphersPagePath
  - antiReplayPagePath
  - cniLink
  - updateHCFrequencyPage
  - tunnelHealthChecksPage
  - biVsUniHealthCheck
  - tunnelHealthDash
  - biVsUniHealthCheckDefaults
  - configureRoutesURL
  - sitesURL?
  - configureARRURL?
  - unifiedRoutingURL
  - troubleshootTunnelHealthURL
  - troubleshootIpsecURL
---

import { AnchorHeading, APIRequest, CURL, DashButton, Details, GlossaryTooltip, Markdown, Render, TabItem, Tabs } from "~/components";

Cloudflare recommends two tunnels for each ISP and network location router combination, one per Cloudflare endpoint. Shortly after your onboarding kickoff call, Cloudflare will assign two Cloudflare endpoint addresses that you can use as the tunnel destinations on your network location's routers/endpoints.

## Before you begin

Before creating a tunnel, make sure you have the following information:

- **Cloudflare endpoint addresses**: Provided by Cloudflare after your onboarding kickoff call.{ props.magicWord === "Magic Transit" && (<> Refer to <a href="/magic-transit/cloudflare-ips/#check-your-cloudflare-ips">Check your Cloudflare IPs</a> for more information.</>)}
- **Customer endpoint IP**: A public Internet routable IP address outside of the prefixes Cloudflare will advertise on your behalf (typically provided by your ISP). Not required if using [Cloudflare Network Interconnect](/network-interconnect/) or for <GlossaryTooltip term="IPsec tunnel">IPsec</GlossaryTooltip> tunnels (unless your router uses an <GlossaryTooltip term="Internet key exchange (IKE)">IKE</GlossaryTooltip> ID of type `ID_IPV4_ADDR`).
- **Interface address**: A `/31` (recommended) or `/30` subnet from RFC 1918 private IP space (`10.0.0.0/8`, `172.16.0.0/12`, `192.168.0.0/16`) or `169.254.240.0/20`{props.ipRange}.

:::caution
Make sure the interface address prefixes are always within the allowed Cloudflare ranges, especially for cloud service providers that might automatically generate prefixes for you. Otherwise, the tunnel will not work.
:::

## Ways to onboard traffic to Cloudflare

### GRE and IPsec tunnels

You can use GRE or IPsec tunnels to onboard your traffic to {props.productName}, and set them up through the Cloudflare dashboard or the API. If you use the API, you need your [account ID](/fundamentals/account/find-account-and-zone-ids/) and [API key](/fundamentals/api/get-started/keys/#view-your-global-api-key).

{ props.magicWord === "Magic Transit" && (
  <>
		<Render file="routing/anycast-warning" product="networking-services" />
	</>
)
}

#### Choose between GRE and IPsec

| Feature | GRE | IPsec |
|---------|-----|-------|
| Encryption | No | Yes |
| Authentication | No | Pre-shared key (PSK) |
| Setup complexity | Simpler | Requires PSK exchange |
| Best for | Trusted networks, CNI connections | Internet-facing connections requiring encryption |

Refer to <a href={props.tunnelsAndEncapsulationPagePath}>Tunnels and encapsulation</a> to learn more about the technical requirements for both tunnel types.

#### IPsec supported ciphers

Refer to <a href={props.ciphersPagePath}>supported ciphers for IPsec</a> for a complete list. IPsec tunnels only support Internet Key Exchange version 2 (IKEv2).

#### Anti-replay protection

If you use {props.productName} and <GlossaryTooltip term="anycast">anycast</GlossaryTooltip> IPsec tunnels, we recommend disabling anti-replay protection. Cloudflare disables this setting by default. However, you can enable it through the API or the Cloudflare dashboard for devices that do not support disabling it, including Cisco Meraki, Velocloud, and AWS VPN Gateway.

Refer to <a href={props.antiReplayPagePath}>Anti-replay protection</a> for more information on this topic, or [Add IPsec tunnels](#add-ipsec-tunnel) to learn how to enable this feature.

### Network Interconnect (CNI)

Beyond GRE and IPsec tunnels, you can also use Network Interconnect (CNI) to onboard your traffic to {props.productName}. Refer to <a href={props.cniLink}>Network Interconnect (CNI)</a> for more information.

## Add tunnels

<Render
	file="icmp-mfirewall"
	product="networking-services"
	params={{
		mFirewallName: "Magic Firewall rules",
		mFirewallURL: "/magic-firewall/about/ruleset-logic/#magic-firewall-rules-and-magic-transit-endpoint-health-checks"
	}}
	/>

<Tabs syncKey="dashPlusAPI"> <TabItem label="Dashboard">

{/* Dashboard steps for WAN Tunnels (Cloudflare One dashboard) */}
{ props.magicWord === "WAN Tunnels" && (
	<>
	<Markdown
	text={`
	1. Log in to <a href="https://one.dash.cloudflare.com/">Cloudflare One</a>, and go to **Networks**.
	2. Go to **Connectors** > **WAN Tunnels**, and select **Create**.
	3. On the **Add Tunnel** page, choose either a **GRE tunnel** or **IPsec tunnel**.
	`}
	inline={false}
	/>
	</>
)
}

{/* Dashboard steps for Magic WAN and Magic Transit (standalone dashboards) */}
{ props.magicWord !== "WAN Tunnels" && (
	<>
	<Markdown
	text={`
	1. Go to **Connectors** page.
		`}
	inline={false}
	/>

	<DashButton url="/?to=/:account/magic-networks/connections" />

	<Markdown
	text={`
	2. From the **IPsec/GRE tunnels** tab, select **Create a tunnel**.
	3. On the **Add tunnels** page, choose either a **GRE tunnel** or **IPsec tunnel**.
	`}
	inline={false}
	/>
	</>
)
}

4. In **Name**, give your tunnel a descriptive name. This name must be unique, cannot contain spaces or special characters, and cannot be shared with other tunnels.
5. _(Optional)_ Give your tunnel a description in **Description**.
6. In **IPv4 Interface address**, enter the internal IP address for your tunnel along with the interface's prefix length (`/31` or `/30`). This is used to route traffic through the tunnel on the Cloudflare side. We recommend using a `/31` subnet, as it provides the most efficient use of IP address space.

Expand the section below for your tunnel type to complete the configuration:

<span id="add-gre-tunnel"></span>
<Details header="GRE tunnel">

7. In **Customer GRE endpoint**, enter your router's public IP address. You do not need this value if you use a physical or virtual connection like Cloudflare Network Interconnect because Cloudflare provides it.
8. In **Cloudflare GRE endpoint**, enter the anycast address you received from your account team.{ props.magicWord === "Magic Transit" && (<> Refer to <a href="/magic-transit/cloudflare-ips/#check-your-cloudflare-ips">Check your Cloudflare IPs</a> for more information.</>)}
9. _(Optional)_ Leave the default values for **TTL** and **MTU**, or customize them for your network.
10. _(Optional)_ Configure health check settings. Expand the following to learn more about each option:

    <Render
      file="routing/tunnel-health-check-options"
      product="networking-services"
      params={{
        tunnelHealthDash: props.tunnelHealthDash,
        tunnelHealthChecksPage: props.tunnelHealthChecksPage,
        updateHCFrequencyPage: props.updateHCFrequencyPage,
        biVsUniHealthCheck: props.biVsUniHealthCheck,
        productName: props.productName
      }}
    />

11. _(Optional)_ We recommend you test your tunnel before officially adding it. To test the tunnel, select **Test tunnels**.
{ props.magicWord !== "Magic Transit" && (<Markdown text={`12. (_Optional_) Select **Automatic return routing** if you are setting up this tunnel for a site that only needs to send traffic to and receive responses from Cloudflare, and does not need to receive traffic from other sites in your WAN. This feature requires <a href="${props.unifiedRoutingURL}">Unified Routing (beta)</a>. Refer to [Configure Automatic Return Routing](${props.configureARRURL}) for more information.`} inline={false} />)}
<Markdown text={`${props.magicWord !== "Magic Transit" ? "13" : "12"}. To add multiple tunnels, select **Add GRE tunnel** for each new tunnel.`} inline={false} />
<Markdown text={`${props.magicWord !== "Magic Transit" ? "14" : "13"}. After adding your tunnel information, select **Add tunnels**.`} inline={false} />
<Markdown text={`${props.magicWord !== "Magic Transit" ? "15" : "14"}. (_Optional_) Select **Allow BGP (Border Gateway Protocol) peering** (beta) if you want to dynamically exchange routes between your network and Cloudflare. This feature requires <a href="${props.unifiedRoutingURL}">Unified Routing (beta)</a>. <br /> BGP is recommended for environments with frequently changing routes or when you need automatic failover. Refer to [Configure BGP routes](${props.configureRoutesURL}#configure-bgp-routes) for more information.`} inline={false} />

</Details>

<span id="add-ipsec-tunnel"></span>
<Details header="IPsec tunnel">

7. _(Optional)_ In **Customer endpoint**, enter your router's public IP address. This value is only required if your router uses an IKE ID of type `ID_IPV4_ADDR`.
8. In **Cloudflare endpoint**, enter the anycast address you received from your account team.{ props.magicWord === "Magic Transit" && (<> Refer to <a href="/magic-transit/cloudflare-ips/#check-your-cloudflare-ips">Check your Cloudflare IPs</a> for more information.</>)}
9. _(Optional)_ Configure health check settings. Expand the following to learn more about each option:

    <Render
      file="routing/tunnel-health-check-options"
      product="networking-services"
      params={{
        tunnelHealthDash: props.tunnelHealthDash,
        tunnelHealthChecksPage: props.tunnelHealthChecksPage,
        updateHCFrequencyPage: props.updateHCFrequencyPage,
        biVsUniHealthCheck: props.biVsUniHealthCheck,
        productName: props.productName
      }}
    />

    :::note
    IPsec tunnels will not function without a pre-shared key (PSK).
    :::

10. If you do not have a pre-shared key yet:

    1. Select **Add pre-shared key later**.
    2. _(Optional)_ We recommend you test your tunnel configuration before officially adding it. To test the tunnel, select **Test tunnels**.
    3. Select **Add tunnels**.
    4. The Cloudflare dashboard loads the list of tunnels you have configured. The IPsec tunnel you just created displays a warning triangle icon to indicate it is not yet functional. Select **Edit**.
    5. Choose **Generate a new pre-shared key** > **Update and generate a pre-shared key**. Save the key to a safe place, and select **Done**.

11. If you already have a pre-shared key:

    1. Select **Use my own pre-shared key**.
    2. Paste your key in **Your pre-shared key**.
    3. _(Optional)_ We recommend you test your tunnel before officially adding it. To test the tunnel, select **Test tunnels**.
    4. Select **Add tunnels**.

12. _(Optional)_ Enable **Replay protection** if you have devices that do not support disabling it. Refer to <a href={props.antiReplayPagePath}>Anti-replay protection</a> for more information.
{ props.magicWord !== "Magic Transit" && (<Markdown text={`13. (_Optional_) Select **Automatic return routing** if you are setting up this tunnel for a site that only needs to send traffic to and receive responses from Cloudflare, and does not need to receive traffic from other sites in your WAN. This feature requires <a href="${props.unifiedRoutingURL}">Unified Routing (beta)</a>. Refer to [Configure Automatic Return Routing](${props.configureARRURL}) for more information.`} inline={false} />)}
<Markdown text={`${props.magicWord !== "Magic Transit" ? "14" : "13"}. To add multiple tunnels, select **Add IPsec tunnel** for each new tunnel.`} inline={false} />
<Markdown text={`${props.magicWord !== "Magic Transit" ? "15" : "14"}. After adding your tunnel information, select **Add tunnels**.`} inline={false} />
<Markdown text={`${props.magicWord !== "Magic Transit" ? "16" : "15"}. (_Optional_) Select **Allow BGP (Border Gateway Protocol) peering** (beta) if you want to dynamically exchange routes between your network and Cloudflare. This feature requires <a href="${props.unifiedRoutingURL}">Unified Routing (beta)</a>. <br /> BGP is recommended for environments with frequently changing routes or when you need automatic failover. Refer to [Configure BGP routes](${props.configureRoutesURL}#configure-bgp-routes) for more information.`} inline={false} />

</Details>

</TabItem> <TabItem label="API">

<Render file="account-id-api-key" product="networking-services" />

<Details header="GRE tunnel">

Create a `POST` request [using the API](/api/resources/magic_transit/subresources/gre_tunnels/methods/create/) to create a GRE tunnel.

<APIRequest
  path="/accounts/{account_id}/magic/gre_tunnels"
  method="POST"
  json={{
		"name": "<TUNNEL_NAME>",
		"description": "<TUNNEL_DESCRIPTION>",
		"interface_address": "<INTERFACE_ADDRESS>",
		"cloudflare_gre_endpoint": "<CLOUDFLARE_ENDPOINT>",
		"customer_gre_endpoint": "<CUSTOMER_ENDPOINT>"
  }}
/>

```json output
{
  "errors": [
    {
      "code": 1000,
      "message": "message"
    }
  ],
  "messages": [
    {
      "code": 1000,
      "message": "message"
    }
  ],
  "result": {
    "gre_tunnels": [
      {
        "cloudflare_gre_endpoint": "<IP_ADDRESS>",
        "customer_gre_endpoint": "<IP_ADDRESS>",
        "interface_address": "<INTERFACE_CIDR>",
        "name": "<TUNNEL_NAME>",
        "description": "<TUNNEL_DESCRIPTION>",
        "health_check": {
          "direction": "unidirectional",
          "enabled": true,
          "rate": "low",
          "type": "reply"
        },
        "mtu": 0,
        "ttl": 0
      }
    ]
  },
  "success": true
}
```

</Details>

<Details header="IPsec tunnel">

1. Create a `POST` request [using the API](/api/resources/magic_transit/subresources/ipsec_tunnels/methods/create/) to create an IPsec tunnel.

	Note that in the example, replay protection is disabled by default. You can enable it with the flag `"replay_protection": true` for each IPsec tunnel, if the devices you use do not support disabling this feature. If you have already created IPsec tunnels, update them with a [`PUT` request](/api/resources/magic_transit/subresources/ipsec_tunnels/methods/update/). Refer to <a href={props.antiReplayPagePath}>Anti-replay protection</a> for more information on this topic.

	<APIRequest
		path="/accounts/{account_id}/magic/ipsec_tunnels"
		method="POST"
		json={{
			"name": "<TUNNEL_NAME>",
			"description": "<TUNNEL_DESCRIPTION>",
			"interface_address": "<INTERFACE_ADDRESS>",
			"cloudflare_endpoint": "<CLOUDFLARE_ENDPOINT>",
			"customer_endpoint": "<CUSTOMER_ENDPOINT>"
		}}
	/>

	```json output
	{
		"errors": [
			{
				"code": 1000,
				"message": "message"
			}
		],
		"messages": [
			{
				"code": 1000,
				"message": "message"
			}
		],
		"result": {
			"ipsec_tunnels": [
				{
					"id": "<IPSEC_TUNNEL_ID>",
					"interface_address": "<INTERFACE_CIDR>",
					"name": "<TUNNEL_NAME>",
					"cloudflare_endpoint": "<IP_ADDRESS>",
					"customer_endpoint": "<IP_ADDRESS>",
					"description": "<TUNNEL_DESCRIPTION>",
					"health_check": {
						"direction": "unidirectional",
						"enabled": true,
						"rate": "low",
						"type": "reply"
					},
					"psk_metadata": {},
					"replay_protection": false
				}
			]
		},
		"success": true
	}
	```

	Take note of the tunnel `id` value. We will use it to generate a pre-shared key (PSK).

2. Create a `POST` [request](/api/resources/magic_transit/subresources/ipsec_tunnels/methods/psk_generate/) to generate a PSK. Use the tunnel `id` value you received from the previous command.

	<APIRequest
		path="/accounts/{account_id}/magic/ipsec_tunnels/{ipsec_tunnel_id}/psk_generate"
		method="POST"
	/>

	```json output
	{
		"result": {
			"ipsec_id": "<IPSEC_ID>",
			"ipsec_tunnel_id": "<IPSEC_TUNNEL_ID>",
			"psk": "<PSK_CODE>",
			"psk_metadata": {
				"last_generated_on": "2025-03-13T14:28:47.054317925Z"
			}
		},
		"success": true,
		"errors": [],
		"messages": []
	}
	```

	Take note of your `psk` value.

3. Create a `PUT` [request](/api/resources/magic_transit/subresources/ipsec_tunnels/methods/update/) to update your IPsec tunnel with the PSK.

	<CURL
		url="https://api.cloudflare.com/client/v4/accounts/{account_id}/magic/ipsec_tunnels/{ipsec_tunnel_id}"
		method="PUT"
		json={{
			"psk": "<PSK_VALUE>"
		}}
	/>

```json output
{
  "result": {
    "modified": true,
    "modified_ipsec_tunnel": {
      "id": "<IPSEC_ID>",
      "interface_address": "<IPSEC_CIDR>",
      "created_on": "2025-03-13T14:28:21.139535Z",
      "modified_on": "2025-03-13T14:33:26.09683Z",
      "name": "<TUNNEL_NAME>",
      "cloudflare_endpoint": "<IP_ADDRESS>",
      "customer_endpoint": "<IP_ADDRESS>",
      "remote_identities": {
        "hex_id": "",
        "fqdn_id": "",
        "user_id": ""
      },
      "psk_metadata": {
        "last_generated_on": "2025-03-13T14:28:47.054318Z"
      },
      "description": "<TUNNEL_DESCRIPTION>",
      "health_check": {
        "enabled": true,
        "target": "",
        "type": "reply",
        "rate": "mid",
        "direction": "unidirectional"
      }
    }
  },
  "success": true,
  "errors": [],
  "messages": []
}
```

4. Use the `psk` value from step 3 to configure the IPsec tunnel on your equipment as well.

</Details>

<Details header="Configure bidirectional health checks">

Bidirectional health checks are available for GRE and IPsec tunnels. {props.biVsUniHealthCheckDefaults}.

You can change this setting via the API with `"bidirectional"` or `"unidirectional"`:

<CURL
	url="https://api.cloudflare.com/client/v4/accounts/{account_id}/magic/ipsec_tunnels/{ipsec_tunnel_id}"
	method="PUT"
	json={{
		"health_check":
			{
				"direction": "bidirectional"
			}
	}}
/>

```json output
{
  "result": {
    "modified": true,
    "modified_ipsec_tunnel": {
      "id": "<IPSEC_ID>",
      "interface_address": "<IPSEC_CIDR>",
      "created_on": "2025-03-13T14:28:21.139535Z",
      "modified_on": "2025-03-13T14:33:26.09683Z",
      "name": "<TUNNEL_NAME>",
      "cloudflare_endpoint": "<IP_ADDRESS>",
      "customer_endpoint": "<IP_ADDRESS>",
      "remote_identities": {
        "hex_id": "",
        "fqdn_id": "",
        "user_id": ""
      },
      "psk_metadata": {
        "last_generated_on": "2025-03-13T14:28:47.054318Z"
      },
      "description": "<TUNNEL_DESCRIPTION>",
      "health_check": {
        "enabled": true,
        "target": "",
        "type": "reply",
        "rate": "mid",
        "direction": "bidirectional"
      }
    }
  },
  "success": true,
  "errors": [],
  "messages": []
}
```

</Details>

</TabItem> </Tabs>

## Bidirectional vs unidirectional health checks

To check for tunnel health, Cloudflare sends a <a href={props.tunnelHealthChecksPage}>health check probe</a> consisting of ICMP (Internet Control Message Protocol) reply [packets](https://www.cloudflare.com/learning/network-layer/what-is-a-packet/) to your network. Cloudflare needs to receive these probes to know if your tunnel is healthy.

{/*
	Conditional logic explanation:
	- Magic Transit page: "unidirectional health checks for Magic Transit, and bidirectional health checks for Magic WAN"
	- Magic WAN/WAN Tunnels pages: "bidirectional health checks for [productName], and unidirectional health checks for Magic Transit"
	This avoids saying "Magic Transit defaults to...Magic Transit" on the Magic Transit page.
*/}
Cloudflare defaults to {props.magicWord === "Magic Transit" ? "unidirectional" : "bidirectional"} health checks for {props.magicWord === "Magic Transit" ? "Magic Transit (direct server return)" : props.productName}, and {props.magicWord === "Magic Transit" ? "bidirectional" : "unidirectional"} health checks for {props.magicWord === "Magic Transit" ? "Magic WAN" : "Magic Transit (direct server return)"}. However, routing unidirectional ICMP reply packets over the Internet to Cloudflare is sometimes subject to drops by intermediate network devices, such as stateful firewalls. Magic Transit customers with egress traffic can modify this setting to bidirectional.

{ props.magicWord === "Magic Transit" && (
  <>
	<p>If you are a Magic Transit customer with egress traffic, refer to <a href="/magic-transit/reference/egress/">Magic Transit egress traffic</a> for more information on the technical aspects you need to consider to create a successful connection to Cloudflare.</p>
  </>
  )
}

### Legacy bidirectional health checks

For customers using the legacy health check system with a public IP range, Cloudflare recommends:

- Configuring the tunnel health check target IP address to one within the `172.64.240.252/30` prefix range.
- Applying a policy-based route that matches [packets](https://www.cloudflare.com/learning/network-layer/what-is-a-packet/) with a source IP address equal to the configured tunnel health check target (for example `172.64.240.253/32`), and route them over the tunnel back to Cloudflare.

## Next steps

Now that you have set up your tunnel endpoints, you need to configure routes to direct your traffic through Cloudflare. You have two routing options:

- **Static routes**: Best for simple, stable networks where routes rarely change. You manually define each route.
- **BGP peering**: Best for dynamic environments with frequently changing routes, multiple prefixes, or when you need automatic failover. Requires enabling BGP on your tunnel during creation.

Refer to <a href={props.configureRoutesURL}>Configure routes</a> for detailed instructions on both options.

{ props.magicWord !== "Magic Transit" && (
  <p>After configuring your routes, you need to <a href={props.sitesURL}>set up a site</a>.</p>
)}

## Troubleshooting

If you experience issues with your tunnels:

- For tunnel health check problems, refer to <a href={props.troubleshootTunnelHealthURL}>Troubleshoot tunnel health</a>.
- For IPsec tunnel establishment issues, refer to <a href={props.troubleshootIpsecURL}>Troubleshoot with IPsec logs</a>.
