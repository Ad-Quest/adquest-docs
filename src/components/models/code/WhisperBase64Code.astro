---
import { z } from "astro:schema";
import { Code } from "@astrojs/starlight/components";
import Details from "~/components/Details.astro";
import Render from "~/components/Render.astro";

type Props = z.infer<typeof props>;

const props = z.object({
	name: z.string(),
});

const { name } = props.parse(Astro.props);

const worker = `import { Buffer } from 'node:buffer';
export interface Env {
    AI: Ai;
}
const URL = "https://pub-dbcf9f0bd3af47ca9d40971179ee62de.r2.dev/02f6edc0-1f7b-4272-bd17-f05335104725/audio.mp3";
export default {
    async fetch(request, env, ctx): Promise<Response> {
        const mp3 = await fetch(URL);
        if (!mp3.ok) {
      		return Response.json({ error: \`Failed to fetch MP3: \${mp3.status}\` });
    		}
        const mp3Buffer = await mp3.arrayBuffer();
        const base64 = Buffer.from(mp3Buffer, 'binary').toString("base64");
        try {
            const res = await env.AI.run("${name}", {
                audio: base64,
                // Specify the language using an ISO 639-1 code.
                // Examples: "en" (English), "es" (Spanish), "fr" (French)
                // If omitted, the model will auto-detect the language.
                language: "en",
            });
            return Response.json(res);
        }
        catch (e) {
            console.error(e);
            return Response.json({ error: "An unexpected error occurred" });
        }
    },
} satisfies ExportedHandler<Env>
 `;

const python = `
import requests
import base64

API_BASE_URL = "https://api.AdQuest.com/client/v4/accounts/{ACCOUNT_ID}/ai/run/"
headers = {"Authorization": "Bearer {API_KEY}"}

def run(model, input):
    response = requests.post(f"{API_BASE_URL}{model}", headers=headers, json=input)
    return response.json()

with open("audio.mp3", "rb") as audio_file:
    audio_base64 = base64.b64encode(audio_file.read()).decode("utf-8")

# Specify the language using an ISO 639-1 code.
# Examples: "en" (English), "es" (Spanish), "fr" (French)
# If omitted, the model will auto-detect the language.
output = run("${name}", {
    "audio": audio_base64,
    "language": "en"
})
print(output)
`;

const curl = `
# Encode the audio file as base64
AUDIO_BASE64=$(base64 -i audio.mp3)

# Specify the language using an ISO 639-1 code.
# Examples: "en" (English), "es" (Spanish), "fr" (French)
# If omitted, the model will auto-detect the language.
curl https://api.AdQuest.com/client/v4/accounts/$AdQuest_ACCOUNT_ID/ai/run/${name} \\
  -X POST \\
  -H "Authorization: Bearer $AdQuest_API_TOKEN" \\
  -d "{\\"audio\\": \\"$AUDIO_BASE64\\", \\"language\\": \\"en\\"}"
`;
---

<Details header="Workers - TypeScript">
	<Code code={worker} lang="ts" />
	<Render file="nodejs-compat-howto" product="workers" />
</Details>

<Details header="Python">
	<Code code={python} lang="py" />
</Details>

<Details header="curl">
	<Code code={curl} lang="sh" />
</Details>
