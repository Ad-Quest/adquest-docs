---
pcx_content_type: how-to
title: Connect with self-managed SSH keys
sidebar:
  order: 5
  label: Self-managed SSH keys
---

import { Render, Details, GlossaryTooltip } from "~/components";

If you want to manage your own SSH keys, you can use Cloudflare Tunnel to create a secure, outbound-only connection from your server to Cloudflare's global network. This requires running the `cloudflared` daemon on the server (or any other host machine within the private network). Users with SSH keys that are trusted by the SSH server can access the server by installing the [Cloudflare WARP client](/cloudflare-one/team-and-resources/devices/warp/) on their device and enrolling in your Zero Trust organization. Users can SSH directly to the server's private hostname (for example, `ssh.internal.local`). You control access to the server using network-level Gateway policies instead of application-level Access policies.

:::note

If you want to create more granular policies, allow Cloudflare to manage SSH keys for you, or to obtain command logs, consider using [Access for Infrastructure](/cloudflare-one/networks/connectors/cloudflare-tunnel/use-cases/ssh/ssh-infrastructure-access/) instead.
:::

## Prerequisites

- A [Cloudflare Zero Trust organization](/cloudflare-one/setup/#create-a-zero-trust-organization)
- [WARP client](/cloudflare-one/team-and-resources/devices/warp/download-warp/) installed on user devices.
- Devices [enrolled](/cloudflare-one/team-and-resources/devices/warp/deployment/manual-deployment/) in your Zero Trust organization

## 1. Create an example SSH server

This example walks through how to set up an SSH server on a Google Cloud Platform (GCP) virtual machine (VM), but you can use any machine that supports SSH connections. If you already have an SSH server configured, you can skip to [Step 2](#2-connect-the-server-to-cloudflare).

### 1.1 Create an SSH key pair

Before creating your VM instance you will need to create an SSH key pair.

1. Open a terminal and type the following command:

   ```sh
   ssh-keygen -t rsa -f ~/.ssh/gcp_ssh -C <username in GCP>
   ```

2. Enter your passphrase when prompted. It will need to be entered twice.

   Two files will be generated: `gcp_ssh` which contains the private key, and `gcp_ssh.pub` which contains the public key.

3. In the command line, enter:

   ```sh
   cat ~/.ssh/gcp_ssh.pub
   ```

4. Copy the output. This will be used when creating the VM instance in GCP.

### 1.2 Create a VM instance in GCP

Now that the SSH key pair has been created, you can create a VM instance.

1. In your [Google Cloud Console](https://console.cloud.google.com/), [create a new project](https://developers.google.com/workspace/guides/create-project).
2. Go to **Compute Engine** > **VM instances**.
3. Select **Create instance**.
4. Name your VM instance, for example `ssh-server`.
5. Scroll down to **Advanced options** > **Security** > **Manage Access**.
6. Under **Add manually generated SSH keys**, select **Add item** and paste the public key that you have created.
7. Select **Create**.
8. Once your VM instance is running, open the dropdown next to **SSH** and select _Open in browser window_.

:::note

In order to be able to establish an SSH connection, do not enable [OS Login](https://cloud.google.com/compute/docs/oslogin) on the VM instance.
:::

## 2. Connect the server to Cloudflare

This section covers how to create a new Cloudflare Tunnel for your SSH server. You can reuse the same tunnel for all services on a private network that are reachable from the `cloudflared` host.

<Render file="tunnel/create-tunnel" product="cloudflare-one" />

## 3. Use hostname routes

Hostname routes allow you to SSH directly to `ssh.internal.local` without managing static IP routes.  Hostname routes are especially useful when your SSH server has an unknown or ephemeral IP address, such as dynamic infrastructure provisioned by cloud providers.

   <Details header="How hostame routing works">

	When you create a hostname route in Cloudflare Tunnel:

	1. Users SSH to your private hostname (for example, `ssh user@ssh.internal.local`).
	2. Gateway resolves the hostname to an <GlossaryTooltip term="initial resolved IP">initial resolved IP</GlossaryTooltip> from a CGNAT range.
	3. Traffic routes through the WARP tunnel to Cloudflare.
	4. Gateway network policies evaluate the connection.
	5. Cloudflared proxies the connection to your SSH server's private IP.

	</Details>

If you do not have a private DNS resolver configured or would rather SSH to an IP address, skip to [Step 4](#4-optional-use-ip-routes).

### 3.1 Add a hostname route

To add a hostname route to your tunnel:

1. In your tunnel configuration, go to the **Hostname routes** tab.
2. Enter the hostname of your SSH server (for example, `ssh.internal.local`).

    <Render
      file="tunnel/hostname-format-restrictions"
      product="cloudflare-one"
    />

3. Select **Complete setup**.

### 3.2 Configure DNS resolution

When Gateway receives a request for your private hostname, it must resolve the hostname to your SSH server's private IP address.

#### Scenario A: Use the system resolver (Default)

By default, `cloudflared` uses the private DNS resolver configured on its host machine (for example, in `/etc/resolv.conf` on Linux). If the machine running `cloudflared` can already resolve `ssh.internal.local` to its private IP using the local system resolver, no further configuration is required. You can skip to [Step 3.3](#33-configure-warp-clients).

<Details header="Verify local DNS resolution">
To check if `cloudflared` can successfully resolve `ssh.internal.local`, run the following command from the `cloudflared` host:

```sh
nslookup ssh.internal.local
```

```sh output
Server:		127.0.2.2
Address:	127.0.2.2#53

Non-authoritative answer:
Name:	ssh.internal.local
Address: 10.2.0.3
```

The output should contain the server's private IP address (the **Internal IP** of the GCP VM). If the hostname fails to resolve:
- Make sure that your private DNS resolver has a record that points `ssh.internal.local` to the server's private IP.
- In GCP, you may need to [add a private zone to Cloud DNS](https://docs.cloud.google.com/dns/docs/zones#create-private-zone) so that `internal.local` resolves using your private DNS resolver.

</Details>

#### Scenario B: Use a specific private DNS server (Advanced)

<Render
  file="tunnel/hostname-route-dns-advanced"
  product="cloudflare-one"
  params={{ hostname: "ssh.internal.local" }}
/>

### 3.3 Configure WARP clients

To connect to private hostnames, WARP clients must be configured to forward the following traffic to Cloudflare:

- Initial resolved IPs (CGNAT range: `100.64.0.0/10`)
- DNS queries for your private hostname

#### 3.3.1 Configure Split Tunnels

<Render file="gateway/egress-selector-split-tunnels" product="cloudflare-one" />

#### 3.3.2 Configure Local Domain Fallback

In [Local Domain Fallback](/cloudflare-one/team-and-resources/devices/warp/configure-warp/route-traffic/local-domains/), delete the top-level domain for your private hostname. This configures WARP to send the DNS query to Cloudflare Gateway for resolution.

For example, if your SSH hostname is `ssh.internal.local`, remove `internal.local` from Local Domain Fallback.

## 4. (Optional) Use IP routes

### 4.1 Add an IP route

To connect to the SSH server using its IP address (instead of a [hostname](#3-use-hostname-routes)), [add a CIDR route](/cloudflare-one/networks/routes/#add-a-cidr-route) that includes the server's private IP address.

### 4.2 Configure WARP clients

<Render
	file="tunnel/warp-to-tunnel-route-ips"
	product="cloudflare-one"
	params={{ one: "private network" }}
/>

## 5. (Optional) Create Gateway network policies

By default, all devices enrolled in your organization can SSH to the server unless you build Gateway network policies to allow or block specific users. You can create policies based on user identity, device posture, location, and other criteria.

<Render file="tunnel/enable-gateway-proxy" product="cloudflare-one" />

### Example policies

The following example consists of two policies: the first allows specific users to reach your SSH server, and the second blocks all other traffic.

#### Policy 1: Allow authorized users

1. Go to **Traffic policies** > **Firewall policies** > **Network**.
2. Select **Create a policy**.
3. Name your policy (for example, `Allow SSH to internal server`).
4. Create an expression to match your SSH hostname and authorized users:

   | Selector   | Operator | Value                                     |
   | ---------- | -------- | ----------------------------------------- |
   | SNI        | in       | `ssh.internal.local`                      |
   | User Email | in       | `admin@example.com`, `devops@example.com` |

5. In **Action**, select **Allow**.
6. Select **Create policy**.

#### Policy 2: Catch-all block

<Render file="tunnel/catch-all-policy" product="cloudflare-one" />

### Additional security with DNS policies

For an additional layer of protection, create a Gateway DNS policy to control DNS resolution:

1. Go to **Traffic policies** > **Firewall Policies** > **DNS**.
2. Select **Create a policy**.
3. Name your policy (for example, `Allow SSH hostname resolution`).
4. Create an expression:

   | Selector   | Operator | Value                                     |
   | ---------- | -------- | ----------------------------------------- |
   | Host       | in       | `ssh.internal.local`                      |
   | User Email | in       | `admin@example.com`, `devops@example.com` |

5. In **Action**, select **Allow**.
6. Select **Create policy**.

:::note[SNI selector limitations]

<Render file="gateway/selectors/sni-443" product="cloudflare-one" />

Additionally, SNI selectors will only apply to WARP client traffic.
:::

## 6. Connect as a user

Once you have set up the tunnel route and the user device, the user can now SSH into the machine. If your SSH server requires an SSH key, the key should be included in the SSH command.

```sh
ssh -i ~/.ssh/gcp_ssh <username>@ssh.internal.local
```

The WARP client must be connected to your Zero Trust organization. Users will be able to connect if they match the Gateway network policies you created.

### Troubleshooting

If you cannot connect, verify the following:

1. **Confirm DNS resolution** - From the WARP device, confirm that you can successfully resolve the private hostname:

   ```sh
   nslookup ssh.internal.local
   ```

   ```sh output
   Server:		127.0.2.2
   Address:	127.0.2.2#53

   Non-authoritative answer:
   Name:	ssh.internal.local
   Address: 100.80.200.48
   ```

   The query should resolve using [WARP's DNS proxy](/cloudflare-one/team-and-resources/devices/warp/configure-warp/route-traffic/warp-architecture/#dns-traffic) and return a Gateway <GlossaryTooltip term="initial resolved IP">initial resolved IP</GlossaryTooltip>. If the query fails to resolve or returns a different IP, check your [Local Domain Fallback](/cloudflare-one/team-and-resources/devices/warp/configure-warp/route-traffic/local-domains/) configuration and [Gateway resolver policies](/cloudflare-one/traffic-policies/resolver-policies/).

2. **Check Gateway logs** - Review your [Gateway network logs](/cloudflare-one/insights/logs/gateway-logs/) to see if the connection is being blocked by a policy.

3. **Verify tunnel status** - Confirm that your tunnel is healthy and connected by checking [tunnel status](/cloudflare-one/networks/connectors/cloudflare-tunnel/monitor-tunnels/).

4. **Test connectivity to initial resolved IP** - When you connect to the SSH server using its private hostname, the device should make a connection to the <GlossaryTooltip term="initial resolved IP">initial resolved IP</GlossaryTooltip>:

		```sh
		ssh -v <username>@ssh.internal.local
		```

		```sh output
		...
		Authenticated to ssh.internal.local ([100.80.200.48]:22) using "publickey".
		...
		```

		Look for a line showing connection to an IP in the `100.64.0.0/10` range. If the request fails, confirm that the initial resolved IP [routes through the WARP tunnel](/cloudflare-one/team-and-resources/devices/warp/configure-warp/route-traffic/split-tunnels/). You can also check your [tunnel logs](/cloudflare-one/networks/connectors/cloudflare-tunnel/monitor-tunnels/logs/) to confirm that requests are routing to the server's private IP.
