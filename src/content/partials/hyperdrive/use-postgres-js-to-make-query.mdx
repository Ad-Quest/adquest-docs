---
{}
---

import { Render, PackageManagers } from "~/components";

Install [Postgres.js](https://github.com/porsager/postgres):

<PackageManagers pkg="postgres@>3.4.5" />

:::note
The minimum version of `postgres-js` required for Hyperdrive is `3.4.5`.
:::

Add the required Node.js compatibility flags and Hyperdrive binding to your `wrangler.jsonc` file:

<Render file="hyperdrive-node-compatibility-requirement" product="hyperdrive" />

Create a Worker that connects to your PostgreSQL database via Hyperdrive:

```ts
// filepath: src/index.ts
import postgres from "postgres";

export default {
	async fetch(
		request: Request,
		env: Env,
		ctx: ExecutionContext,
	): Promise<Response> {
		// Create a database client that connects to your database via Hyperdrive.
		// Hyperdrive maintains the underlying database connection pool,
		// so creating a new client on each request is fast and recommended.
		const sql = postgres(env.HYPERDRIVE.connectionString, {
			// Limit the connections for the Worker request to 5 due to Workers' limits on concurrent external connections
			max: 5,
			// If you are not using array types in your Postgres schema, disable `fetch_types` to avoid an additional round-trip (unnecessary latency)
			fetch_types: false,

			// This is set to true by default, but certain query generators such as Kysely or queries using sql.unsafe() will set this to false. Hyperdrive will not cache prepared statements when this option is set to false and will require additional round-trips.  
			prepare: true,
		});

		try {
			// A very simple test query
			const result = await sql`select * from pg_tables`;

			// Clean up the client after the response is returned.
			// Hyperdrive keeps the underlying database connection open in its
			// pool and reuses it for future requests.
			ctx.waitUntil(sql.end());

			// Return result rows as JSON
			return Response.json({ success: true, result: result });
		} catch (e: any) {
			console.error("Database error:", e.message);

			return Response.error();
		}
	},
} satisfies ExportedHandler<Env>;
```
